{% extends 'base.html' %}
{% load static %}
{% load custom_filters %} 

{% block title %}Mon Bureau Virtuel{% endblock %}

{% block content %}
    <div class="desktop">
        {% for file in files %}
            {% if file.name|slice:":9" == "/Desktop/" %}
                <div class="file-icon" ondblclick="openFile('{{ file.id }}','{{ file.file_type }}')" onclick="selectIcon(this)">
                    <img src="{% static 'icons/' %}{{ file.file_type }}.png" alt="{{ file.file_type }}">
                    <div class="file-name">{{ file.name|basename }}</div>
                </div>
            {% endif %}
        {% empty %}
            <p style="color: white; text-shadow: 1px 1px 2px black;">Aucun fichier pour l'instant.</p>
        {% endfor %}

        <div class="file-icon" ondblclick="openExplorer()"  onclick="selectIcon(this)">
            <img src="{% static 'icons/explorer.png' %}" alt="Explorateur">
            <div class="file-name">Explorateur</div>
        </div>

        <div id="explorer-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeExplorer()">&times;</span>
                <h2>Explorateur de Fichiers</h2>
                <button onclick="goBack()">‚¨Ö Retour</button>
                <div id="file-list"></div>
            </div>
        </div>
        
        <div id="image-viewer" class="modal">
            <span class="close" onclick="closeImageViewer()">&times;</span>
            <img id="viewer-img" class="modal-content">
        </div>

        <div id="text-editor" class="modal">
            <div class="modal-content" style="display: flex; flex-direction: column; height: 100%;padding:0;">
                <span class="close" onclick="openPopup()" style="align-self: flex-end;">&times;</span>
                <textarea id="edit-text" style="flex-grow: 1; resize: none;"></textarea>
                <button id='save-button' onclick="" style="align-self: flex-end; margin-top: 10px;">Enregistrer</button>
            </div>
        </div>

        <div id="popup" class="modal">
            <span class="close" onclick="closePopup()">&times;</span>
            <p id="warning" class="modal-content">Enregisrer avant de quitter ?</p>
            <div style="position: absolute; bottom: 10px; right: 10px;">
                <button onclick="closePopup();closeTextEditor()">Quitter</button>
                <button id='save-button-popup' onclick="">Enregistrer</button>
            </div>
        </div>

    </div>
    <script>
        function selectIcon(selectedEl) {
            // R√©cup√®re toutes les ic√¥nes
            const icons = document.querySelectorAll('.file-icon');
            icons.forEach(icon => {
                // Retire la classe active de toutes les ic√¥nes
                if (icon !== selectedEl) {
                    icon.classList.remove('active');
                }
            });
            // Ajoute la classe active sur l'ic√¥ne cliqu√©e
            selectedEl.classList.toggle('active');
        }
    </script>
    <script>
        function openFile(fileId, fileType) {
            if (fileType === "img") {
                openImageViewer(`/desktop/file/?file_id=${encodeURIComponent(fileId)}`);
            } else if (fileType === "txt") {
                openTextEditor(`/desktop/file/?file_id=${encodeURIComponent(fileId)}`, fileId);
            }

        }
    </script>
    <script>
        let currentPath = "";  // Chemin actuel dans media/files/<user_id>/
        
        function openExplorer() {
            document.getElementById("explorer-modal").style.display = "block";
            loadFiles(""); // Charger la racine
        }
    
        function closeExplorer() {
            document.getElementById("explorer-modal").style.display = "none";
        }
    
        function loadFiles(path) {
            currentPath = path;
            let fileList = document.getElementById("file-list");
            fileList.innerHTML = "<p>Chargement...</p>";
    
            fetch(`/desktop/explorer/?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    fileList.innerHTML = "";  // Nettoie la liste
                    if (data.error) {
                        fileList.innerHTML = `<p style="color: red;">${data.error}</p>`;
                        return;
                    }
    
                    // Ajouter les dossiers en premier
                    data.folders.forEach(folder => {
                        let div = document.createElement("div");
                        div.className = "file-item";
                        div.innerHTML = "üìÅ " + folder.name;
                        div.onclick = () => loadFiles(folder.path); // Naviguer dans le dossier
                        fileList.appendChild(div);
                    });
    
                    // Ajouter les fichiers
                    data.files.forEach(file => {
                        let div = document.createElement("div");
                        div.className = "file-item";
                        div.innerHTML = "üìÑ " + file.name;
                        div.onclick = () => openFile(file.id, file.type)
                        fileList.appendChild(div);
                    });
    
                    if (data.folders.length === 0 && data.files.length === 0) {
                        fileList.innerHTML = "<p>Aucun fichier ni dossier.</p>";
                    }
                })
                .catch(error => {
                    console.error("Erreur:", error);
                    fileList.innerHTML = "<p style='color: red;'>Erreur de chargement.</p>";
                });
        }
    
        function goBack() {
            if (currentPath === "") return; // On est d√©j√† √† la racine
    
            let parts = currentPath.split("/").filter(p => p);
            parts.pop(); // Retirer le dernier dossier
            let newPath = parts.join("/");
            loadFiles(newPath); // Charger le nouveau chemin
        }
    </script>
    <script>
        function openImageViewer(imageUrl, fileName) {
            let viewer = document.getElementById("image-viewer");
            let viewerImg = document.getElementById("viewer-img");
            
    
            viewer.style.display = "block";  // Afficher la visionneuse
            fetch(imageUrl)
                .then(response => response.json())
                .then(data => {
                    viewerImg.src = `data:image/png;base64,${data.file_data}`;
                })
    
        }
    
        function closeImageViewer() {
            document.getElementById("image-viewer").style.display = "none";
        }
    </script>

    <script>
        function openTextEditor(textUrl, fileId) {
            let textEditor = document.getElementById("text-editor");
            let editText = document.getElementById("edit-text");
            let buttonSave = document.getElementById("save-button");
            let buttonSavePopup  = document.getElementById("save-button-popup");


            buttonSave.setAttribute("onclick",`saveText(${fileId})`);
            buttonSavePopup.setAttribute("onclick",`saveText(${fileId})`);

            textEditor.style.display = "block";  // Afficher la visionneuse
            fetch(textUrl)
                .then(response => response.json())
                .then(data => {
                    editText.innerText = data.file_data;
                })

        }

        function closeTextEditor() {
            document.getElementById("text-editor").style.display = "none";
        }

        function saveText(fileId) {
           
            let editText = document.getElementById("edit-text").value;

            fetch('/files/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}' // Assurez-vous que le token CSRF est inclus
                },
                body: new URLSearchParams({
                    file_id: fileId,
                    data: editText
                })
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'enregistrement du fichier.');
            });
            closeTextEditor();
            closePopup();
        }

        function closePopup() {
            document.getElementById("popup").style.display = "none";

        }

        function openPopup() {
            document.getElementById("popup").style.display = "block";
        }
    </script>
    



{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/desktop.css' %}">
{% endblock %}






